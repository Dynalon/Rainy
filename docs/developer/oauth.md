Tomboy OAuth authentication 
===========================

ATTENTION: This document is only intended for developers.

Tomboy (or any other OAuth consumer like Tomdroid) uses OAuth for authentication when doing cloud/server synchronisation. The necessary OAuth Urls are retrieved via the [root ApiRef call][api-root], and then used for the the OAuth 1.0a authentication/authorization steps.

  [api-root]: https://live.gnome.org/Tomboy/Synchronization/REST/1.0#http:.2BAC8ALw-domain.2BAC8-api.2BAC8-1.0

- - -

Throughout this document we reference to the semi-official OAuth 1.0a flow chart:

![][oauth-flow]

(source: <http://oauth.net/core/1.0a/>)
Note that the terminology used in the flow chart is represented by an earlier draft of the OAuth specification (see next paragraph) - nevertheless, the flow is still the same.

Terminology
------------

The OAauth 1.0a specification is defined in [RFC5849][oauth-rfc]. For a better understanding, the terminology given in the RFC5849 Section 1.1 is mapped to the Tomboy/Rainy usecase here:

*client (or consumer)*: The Tomboy note taking application (or equivalent clients like tomdroid)
*server (or service provider)*: The cloud synchronisatzion server like Snowy, Rainy, Ubuntu One
*user*: The user (human) that operates Tomboy
*protected resource*: A note on the server

  [oauth-rfc]: http://tools.ietf.org/html/rfc5849
  [oauth-flow]: http://oauth.net/core/diagram.png


Step A: Obtain unauthorized request token
-----------------------------------------

Sample HTTP Headers send by Tomboy when it connects to /oauth/request_token:
(wrapping and linebreaks added)

HttpMethod: POST

	Authorization: OAuth realm="Snowy",
		oauth_callback="http%3A%2F%2Flocalhost%3A8000%2Ftomboy-web-sync%2F",
		oauth_consumer_key="anyone",
		oauth_nonce="2800852",
		oauth_signature="61EhqDJKkVzoZG%2bmwv0trkqaXp0%3d",
		oauth_signature_method="HMAC-SHA1",
		oauth_timestamp="1351664093",
		oauth_version="1.0"

The `oauth_callback` parameter indicates the Url that should be called once the authentication (NOT to be confused with authorization!) is complete. In the above example, Tomboy create a HTTP listener on localhost port 8000 on which it will await the authorization.


Step B: Server sends an unauthorized request token
--------------------------------------------------

The Server (i.e. Rainy) checks that:

* The `consumer_key` is known and valid
	* the `consumer_key` send by Tomboy or other clients MUST be `anyone` - this is a hardcoded value
* The signature of the message is valid
	* this is done with the consumer_secret, which is again the hardcoded value `anyone` in all Tomboy clients

Also this checks are not necessary since the key/secret are publicly known, the OAuth implementation requires this.

After the checks complete, the server responds with a pair of generated values that together form the *unauthorized request token*:

	HTTP/1.1 200 OK
	oauth_token=e8eb5f51-4136-4df4-ac60-adedf79b7ce2
		&oauth_token_secret=d5f971ea-acb4-4b7a-b7d4-561979f455cf
		&oauth_callback_confirmed=true

###### (again, wrapping & line breaks added for documentation)


Step C: Direct user to Service Provider for authentication
-----------------------------------------------------------

The consumer (Tomboy) now uses the authorize url it has requested via the root ApiRef call, which is most likely `/oauth/authorize` and appends the request token obtained in step B:

	GET /oauth/authorize?oauth_token=e8eb5f51-4136-4df4-ac60-adedf79b7ce2
		&oauth_callback=http%3a%2f%2flocalhost%3a8000%2ftomboy-web-sync%2f HTTP/1.1

The above request is a live example is generated by Tomboy. Note that specifing an `oauth_callback` is in violation of the OAUTH 1.0a RFC: The callback MUST be provided in step A. Although additional parameters are allowed in Step C, those additioanl parameters MUST NOT start with the `oauth_` prefix according to RFC5849. In the server implementation (Rainy), we can just ignore this parameter, and use the callback Url from Step A.

TODO: make sure Tomboy actually sends the callback in Step A (like Tomdroid does).

Tomdroid does not specify a callback url in this step (which is in compliance with the OAuth RFC), which means we MUST save the callback url from step A for this request token, or use a hardcoded callback which is most likely `tomdroid://sync`. This special Url scheme `tomdroid` seems to be android specific an is handled by tomdroids internal OAuth consumer library. We just make sure that we redirect to the callback url later on.

### Server response to the user on the `/oauth/authorize` page

The server response MUST be an authorize page and can be any website that performs authentication, for example

* A simple username / password login field
* A simple page asking for a secret passkey (for single-user usage of the Server)
* Maybe a redirect to another website to perform OAuth/OpenID authentication
	* Note that when using OAuth from i.e. Twitter, the Server (Rainy) becomes an OAuth consumer to Twitter, as well as will keep his role as OAuth Service Provider regarding Tomboy - do not confuse the tokens then, because both roles are completely different, and tokens may not be shared across the roles!
* For debugging / testing purposes a simple HTTP Redirect that instantly redirects to the callback using a universally accepted , without authentication what so ever - this means now authentication is performed



	/oauth/authorize?oauth_token=44b937db-cdff-4a55-8bef-ecd6d116239e&oauth_callback=http%3a%2f%2flocalhost%3a8000%2ftomboy-web-sync%2f

